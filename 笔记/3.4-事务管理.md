[TOC]

#### 回顾

1. 什么是事务
   - 事务是由 N 步数据库操作序列组成的逻辑执行单元，这系列操作要么全部执行，要么全部放弃执行
2. 事务的特性（ACID）
   - 原子性（Atomicity）：事务是应用中不可再分的最小执行体
   - 一致性（Consistency）：事务执行的结果，必须使数据从一个一致性状态，变为另一个一致性状态
   - **隔离性（Isolation）**：各个事务的执行互不干扰，任何事务的内部操作对其他事务都是隔离的
   - 持久性（Durability）：事务一旦提交，对数据所做的任何改变都要记录到永久存储器中

#### 事务的隔离性

1. 常见的并发异常
   - 第一类丢失更新、第二类丢失更新
   - 脏读、不可重复读、幻读
2. 常见的隔离级别
   - Read Uncommitted : 读取未提交的数据
   - Read Committed : 读取已经提交的数据
   - Repeatable Read : 可重复读
   - Serializable : 串行化（优先级最高，但是性能非常低）

#### 事务管理（一定要记住记牢）

##### 第一类丢失更新

某一个事务的回滚，导致另一个事务已经更新的数据丢失了。

##### 第二类丢失更新

某一个事务的提交，导致另一个事务已经更新的数据丢失了。

##### 脏读

某一个事务，读取了另外一个事务未提交的数据。

##### 不可重复读

某一个事务，对同一个数据前后读取的结果不一致。

##### 幻读

某一个事务，对同一个表前后查询到的行数不一致。

#### 事务隔离级别

| 隔离级别                                      | 第一类丢失更新      | 脏读 | 第二类丢失更新 | 不可重复读 | 幻读 |
| --------------------------------------------- | ------------------- | ---- | -------------- | ---------- | ---- |
| Read Uncommitted 性能高，但是啥问题都解决不了 | Y(会出现问题)       | Y    | Y              | Y          | Y    |
| **Read Committed**  常用                      | N（不会出现该问题） | N    | Y              | Y          | Y    |
| **Repeatable Read** 常用                      | N                   | N    | N              | N          | Y    |
| Serializable 性能低                           | N                   | N    | N              | N          | N    |

#### 实现机制

##### 悲观锁（数据库）

- 共享锁（ S 锁）

  事务 A 对某数据加了共享锁之后，其他事务只能对该数据加共享锁，但是不能加排他锁

- 排他锁（ X 锁）

  事务 A 对某数据加了排他锁之后，其他事务对该数据既不能加共享锁，也不能加排他锁

##### 乐观锁（自定义）

- 版本号、时间戳等（自定义）

  在更新数据之前，检查版本号是否发生变化。若变化则取消本次更新，否则就更新数据（版本号 + 1）

#### Spring 事务管理

- 声明式事务
  - 通过 XML 配置，声明某方法的事务特征
  - 通过注解，声明某方法的事务特征
- 编程式事务
  - 通过 Transaction Template 管理事务，并通过它执行数据库的操作

